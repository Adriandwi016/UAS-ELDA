<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PZEM MQTT | Bootstrap</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <style>
        body {
            background-color: #f0f2f5;
        }
        .container {
            margin-top: 50px;
        }
        .card-header {
            font-weight: bold;
            background-color: #0d6efd;
            color: white;
            text-align: center;
        }
        .data-label {
            font-size: 1.1rem;
            color: #6c757d;
        }
        .data-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .status-badge {
            font-size: 1rem;
            padding: 8px;
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="card shadow">
            <div class="card-header">
                <h2>âš¡ Realtime Monitoring PZEM-004T/017</h2>
            </div>
            <div class="card-body">
                
                <div class="mb-3">
                    <span id="mqtt-status" class="status-badge bg-danger text-white">ðŸ”´ DISCONNECTED</span>
                </div>

                <div class="row">
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card text-center border-primary">
                            <div class="card-body">
                                <p class="data-label mb-0">Tegangan</p>
                                <h3 id="tegangan" class="data-value">0.0 V</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <p class="data-label mb-0">Arus</p>
                                <h3 id="arus" class="data-value">0.000 A</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <p class="data-label mb-0">Daya</p>
                                <h3 id="daya" class="data-value">0.0 W</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card text-center border-info">
                            <div class="card-body">
                                <p class="data-label mb-0">Energi</p>
                                <h3 id="energi" class="data-value">0.000 kWh</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card text-center border-secondary">
                            <div class="card-body">
                                <p class="data-label mb-0">Frekuensi</p>
                                <h3 id="frekuensi" class="data-value">0.0 Hz</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card text-center border-dark">
                            <div class="card-body">
                                <p class="data-label mb-0">Power Factor</p>
                                <h3 id="pf" class="data-value">0.00</h3>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // --- KONFIGURASI MQTT JAVASCRIPT ---
        const MQTT_BROKER = "broker.emqx.io";
        // Gunakan port 8083 untuk koneksi WebSocket non-TLS
        const MQTT_PORT = 8083; 
        const MQTT_TOPIC = "iot/pzem/data";
        const CLIENT_ID = "web_pzem_viewer_" + parseInt(Math.random() * 10000); 

        let client = null;

        /**
         * Update status koneksi di halaman
         * @param {boolean} isConnected 
         */
        function updateStatus(isConnected) {
            const statusElement = document.getElementById("mqtt-status");
            if (isConnected) {
                statusElement.textContent = "ðŸŸ¢ CONNECTED";
                statusElement.classList.remove('bg-danger');
                statusElement.classList.add('bg-success');
            } else {
                statusElement.textContent = "ðŸ”´ DISCONNECTED (Coba Ulang...)";
                statusElement.classList.remove('bg-success');
                statusElement.classList.add('bg-danger');
            }
        }

        /**
         * Fungsi untuk memulai koneksi MQTT
         */
        function startMqttClient() {
            client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, "/mqtt", CLIENT_ID);
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            const options = {
                timeout: 3,
                // Jika Anda menggunakan username/password:
                // userName: "user_anda", 
                // password: "password_anda",
                onSuccess: onConnect,
                onFailure: onFailure
            };

            try {
                console.log(`Menghubungkan ke ${MQTT_BROKER}:${MQTT_PORT}...`);
                client.connect(options);
            } catch (error) {
                console.error("Gagal memulai koneksi MQTT:", error);
                updateStatus(false);
            }
        }

        function onConnect() {
            console.log("Terhubung ke MQTT Broker!");
            updateStatus(true);
            client.subscribe(MQTT_TOPIC);
            console.log(`Berlangganan topik: ${MQTT_TOPIC}`);
        }

        function onFailure(responseObject) {
            console.error("Koneksi gagal: " + responseObject.errorMessage);
            updateStatus(false);
            setTimeout(startMqttClient, 5000); // Coba lagi
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.warn("Koneksi terputus: " + responseObject.errorMessage);
            }
            updateStatus(false);
            setTimeout(startMqttClient, 5000); // Coba lagi
        }

        // Dipanggil saat pesan diterima
        function onMessageArrived(message) {
            try {
                const payload = JSON.parse(message.payloadString);

                // Update nilai dan tambahkan satuan
                document.getElementById('tegangan').textContent = payload.tegangan.toFixed(1) + " V";
                document.getElementById('arus').textContent = payload.arus.toFixed(3) + " A";
                document.getElementById('daya').textContent = payload.daya.toFixed(1) + " W";
                document.getElementById('energi').textContent = payload.energi.toFixed(3) + " kWh";
                document.getElementById('frekuensi').textContent = payload.frekuensi.toFixed(1) + " Hz";
                document.getElementById('pf').textContent = payload.pf.toFixed(2);

            } catch (e) {
                console.error("Gagal memproses payload JSON:", e);
            }
        }

        // Mulai klien saat halaman dimuat
        window.onload = startMqttClient;
    </script>

</body>
</html>
