<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Data PZEM (MQTT)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .label {
            font-weight: bold;
        }
        .value {
            font-size: 1.1em;
            color: #007bff;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>âš¡ Dashboard Data PZEM (Realtime)</h1>
        
        <div id="mqtt-status" class="status disconnected">Status: **DISCONNECTED**</div>

        <div id="data-display">
            <div class="data-item">
                <span class="label">Tegangan (V):</span>
                <span id="tegangan" class="value">0.0</span>
            </div>
            <div class="data-item">
                <span class="label">Arus (A):</span>
                <span id="arus" class="value">0.000</span>
            </div>
            <div class="data-item">
                <span class="label">Daya (W):</span>
                <span id="daya" class="value">0.0</span>
            </div>
            <div class="data-item">
                <span class="label">Energi (kWh):</span>
                <span id="energi" class="value">0.000</span>
            </div>
            <div class="data-item">
                <span class="label">Frekuensi (Hz):</span>
                <span id="frekuensi" class="value">0.0</span>
            </div>
            <div class="data-item">
                <span class="label">Power Factor (PF):</span>
                <span id="pf" class="value">0.00</span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <script>
        // --- KONFIGURASI MQTT JAVASCRIPT ---
        const MQTT_BROKER = "broker.emqx.io";
        // Gunakan port 8083 atau 8084 untuk koneksi WebSocket (WSS) karena HTTP biasanya memblokir 1883
        const MQTT_PORT = 8083; // Default port WebSocket non-TLS untuk EMQX
        const MQTT_TOPIC = "iot/pzem/data";
        const CLIENT_ID = "web_pzem_viewer_" + parseInt(Math.random() * 100);

        let client = null;

        /**
         * Update status koneksi di halaman
         * @param {boolean} isConnected 
         */
        function updateStatus(isConnected) {
            const statusElement = document.getElementById("mqtt-status");
            if (isConnected) {
                statusElement.textContent = "Status: **CONNECTED**";
                statusElement.className = "status connected";
            } else {
                statusElement.textContent = "Status: **DISCONNECTED**";
                statusElement.className = "status disconnected";
            }
        }

        /**
         * Fungsi untuk memulai koneksi MQTT
         */
        function startMqttClient() {
            // Inisialisasi Klien
            client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, "/mqtt", CLIENT_ID);

            // Set Callback
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            // Opsi koneksi
            const options = {
                timeout: 3,
                onSuccess: onConnect,
                onFailure: onFailure
            };

            // Mencoba konek
            try {
                console.log(`Menghubungkan ke ${MQTT_BROKER}:${MQTT_PORT}...`);
                client.connect(options);
            } catch (error) {
                console.error("Gagal memulai koneksi MQTT:", error);
                updateStatus(false);
            }
        }

        // Dipanggil saat koneksi berhasil
        function onConnect() {
            console.log("Terhubung ke MQTT Broker!");
            updateStatus(true);
            // Subscribe ke topik yang sama dengan Python
            client.subscribe(MQTT_TOPIC);
            console.log(`Berlangganan topik: ${MQTT_TOPIC}`);
        }

        // Dipanggil saat koneksi gagal
        function onFailure(responseObject) {
            console.log("Koneksi gagal: " + responseObject.errorMessage);
            updateStatus(false);
            // Coba lagi setelah 5 detik
            setTimeout(startMqttClient, 5000);
        }

        // Dipanggil saat koneksi terputus
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Koneksi terputus: " + responseObject.errorMessage);
            }
            updateStatus(false);
            // Coba lagi setelah 5 detik
            setTimeout(startMqttClient, 5000);
        }

        // Dipanggil saat pesan diterima
        function onMessageArrived(message) {
            console.log("Pesan diterima di topik " + message.destinationName);
            
            try {
                // Parse payload JSON
                const payload = JSON.parse(message.payloadString);

                // Update nilai di elemen HTML
                document.getElementById('tegangan').textContent = payload.tegangan.toFixed(1) + " V";
                document.getElementById('arus').textContent = payload.arus.toFixed(3) + " A";
                document.getElementById('daya').textContent = payload.daya.toFixed(1) + " W";
                document.getElementById('energi').textContent = payload.energi.toFixed(3) + " kWh";
                document.getElementById('frekuensi').textContent = payload.frekuensi.toFixed(1) + " Hz";
                document.getElementById('pf').textContent = payload.pf.toFixed(2);

            } catch (e) {
                console.error("Gagal memproses payload JSON:", e);
            }
        }

        // Mulai klien saat halaman dimuat
        window.onload = startMqttClient;
    </script>

</body>
</html>
